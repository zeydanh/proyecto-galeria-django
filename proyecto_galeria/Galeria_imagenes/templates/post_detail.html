{% extends 'base.html' %}
{% block title %}{{ post.titulo }} - KoyPics{% endblock %}

{% block content %}
<div class="post-detail-container" data-post-id="{{ post.id }}">
    <div class="vote-section">
        <a href="{% url 'votar' post_id=post.id valor='positivo' %}" class="vote-arrow vote-button" data-valor="positivo">▲</a>
        <span class="vote-count">{{ post.total_votos }}</span>
        <a href="{% url 'votar' post_id=post.id valor='negativo' %}" class="vote-arrow vote-button" data-valor="negativo">▼</a>
    </div>
    </div>

<div class="comments-section">
    <h2 class="comments-title"><span id="total-comentarios">{{ post.total_comentarios }}</span> Comentarios</h2>

    {% if user.is_authenticated %}
        <div class="comment-form">
            <form id="comment-form">
                {% csrf_token %}
                {{ comentario_form.as_p }}
                <button type="submit" class="comment-submit-btn">Comentar</button>
            </form>
        </div>
    {% else %}
        <p><a href="{% url 'login' %}?next={{ request.path }}">Inicia sesión</a> para comentar.</p>
    {% endif %}

    <div class="comment-list" id="comment-list">
        {% for comentario in comentarios %}
            <div class="comment">
                </div>
        {% empty %}
            <p id="no-comments-message" style="color: var(--color-text-secondary);">Aún no hay comentarios.</p>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // --- LÓGICA PARA VOTOS ASÍNCRONOS ---
    document.querySelectorAll('.vote-button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const postId = document.querySelector('.post-detail-container').dataset.postId;
            const valor = this.dataset.valor;
            const url = `/post/${postId}/votar/${valor}/`;

            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken,
                }
            })
            .then(response => response.json())
            .then(data => {
                document.querySelector('.vote-count').textContent = data.total_votos;
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // --- LÓGICA PARA COMENTARIOS ASÍNCRONOS ---
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const postId = document.querySelector('.post-detail-container').dataset.postId;
            const url = `/post/${postId}/`;
            const contenido = document.getElementById('id_contenido').value;

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({ contenido: contenido })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    // Limpiar el textarea
                    document.getElementById('id_contenido').value = '';
                    // Actualizar el contador de comentarios
                    document.getElementById('total-comentarios').textContent = data.total_comentarios;
                    // Añadir el nuevo comentario a la lista
                    const commentList = document.getElementById('comment-list');
                    const noCommentsMessage = document.getElementById('no-comments-message');
                    if (noCommentsMessage) {
                        noCommentsMessage.remove();
                    }
                    const newComment = `
                        <div class="comment">
                            <div class="comment-body">
                                <div class="comment-header">
                                    <span class="comment-author"><a href="/u/${data.autor}/">${data.autor}</a></span>
                                    <span class="comment-date">Justo ahora</span>
                                </div>
                                <p>${data.contenido}</p>
                            </div>
                        </div>`;
                    commentList.insertAdjacentHTML('beforeend', newComment);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }
});
</script>
{% endblock %}